name: ND Benchmark Profile

on:
  workflow_dispatch:

jobs:
  bench:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy

      - name: Install package (editable)
        run: python -m pip install -e .

      - name: Run legacy vs ND benchmark
        env:
          OUTPUT_CSV: benchmarks/legacy_vs_nd_explicit_ci.csv
        run: |
          python scripts/bench_explicit_threads.py --parallels 1,4,16 --reps 3 --output "$OUTPUT_CSV"

      - name: Summarize results
        env:
          OUTPUT_CSV: benchmarks/legacy_vs_nd_explicit_ci.csv
        run: |
          python - <<'PY'
          import csv
          import os
          from pathlib import Path

          csv_path = Path(os.environ["OUTPUT_CSV"])
          if not csv_path.exists():
              raise SystemExit(f"Missing benchmark output: {csv_path}")

          with csv_path.open() as fp:
              reader = csv.DictReader(fp)
              rows = list(reader)

          if not rows:
              summary = "No benchmark rows captured."
          else:
              header = ["shape", "dims", "parallel", "legacy_ms", "nd_ms", "ratio", "max_abs_diff"]
              table = ["| " + " | ".join(header) + " |"]
              table.append("| " + " | ".join(["---"] * len(header)) + " |")
              for row in rows:
                  table.append("| " + " | ".join(row[h] for h in header) + " |")
              summary = "\n".join(table)

          summary_path = Path(os.environ["GITHUB_STEP_SUMMARY"])
          summary_path.write_text("## ND Benchmark Profile\n\n" + summary + "\n")
          PY

      - name: Upload benchmark CSV
        uses: actions/upload-artifact@v4
        with:
          name: legacy-vs-nd-explicit-results
          path: benchmarks/legacy_vs_nd_explicit_ci.csv
          if-no-files-found: error
